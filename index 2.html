<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8">
    <script src="../static/jquery.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!--    <link rel="stylesheet" href="../static/bootstrap-4.5.0-dist/css/bootstrap.min.css">-->
    <!--    <link rel="stylesheet" href="../static/bootstrap-4.5.0-dist/js/bootstrap.min.js">-->
    <!--    -->

    <link href="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.css" rel="stylesheet">
    <script src="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.js"></script>

    <!--    弹窗-->
    <!--    <script src="../static/popper.min.js"></script>-->
    <!--    <script src="https://unpkg.com/@popperjs/core@2.10.2/dist/esm/popper.min.js"></script>-->
    <script src="../static/bootbox.all.min.js"></script>

    <!--    消息弹出-->
    <link href="../static/toastr.min.css" rel="stylesheet">
    <script src="../static/toastr.min.js"></script>


    <title>test</title>

    <style>
        /* Add custom style for table */
        .table-container {
            max-height: 500px;
            overflow: auto;
        }

        .table td, .table th {
            text-align: center;
        }
    </style>

    <style type="text/css">

        /* ============ desktop view ============ */
        @media all and (min-width: 992px) {

            .dropdown-menu li {
                position: relative;
            }

            .dropdown-menu .submenu {
                display: none;
                position: absolute;
                left: 100%;
                top: -7px;
            }

            .dropdown-menu .submenu-left {
                right: 100%;
                left: auto;
            }

            .dropdown-menu > li:hover {
                background-color: #f1f1f1
            }

            .dropdown-menu > li:hover > .submenu {
                display: block;
            }
        }

        /* ============ desktop view .end// ============ */

        /* ============ small devices ============ */
        @media (max-width: 991px) {

            .dropdown-menu .dropdown-menu {
                margin-left: 0.7rem;
                margin-right: 0.7rem;
                margin-bottom: .5rem;
            }

        }

        /* ============ small devices .end// ============ */

    </style>

</head>

<body>


<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Brand</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav1">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="#"> About </a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"> Treeview menu </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"> Dropdown item 1 </a></li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 2 &raquo; </a>
                            <ul class="submenu dropdown-menu">
                                <li><a class="dropdown-item" href="#">Submenu item 1</a></li>
                                <li><a class="dropdown-item" href="#">Submenu item 2</a></li>
                                <li><a class="dropdown-item" href="#">Submenu item 3 &raquo; </a>
                                    <ul class="submenu dropdown-menu">
                                        <li><a class="dropdown-item" href="#">Multi level 1 &raquo;</a>
                                            <ul class="submenu dropdown-menu">
                                                <li><a class="dropdown-item" href="#">Multi level 1</a></li>
                                                <li><a class="dropdown-item" href="#">Multi level 2</a></li>
                                            </ul>
                                        </li>
                                        <li><a class="dropdown-item" href="#">Multi level 2</a></li>
                                    </ul>
                                </li>
                                <li><a class="dropdown-item" href="#">Submenu item 4</a></li>
                                <li><a class="dropdown-item" href="#">Submenu item 5</a></li>
                            </ul>
                        </li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 3 </a></li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 4 </a>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown"> More items </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"> Dropdown item 1 </a></li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 2 &raquo; </a>
                            <ul class="submenu dropdown-menu">
                                <li><a class="dropdown-item" href="#">Submenu item 1</a></li>
                                <li><a class="dropdown-item" href="#">Submenu item 2</a></li>
                                <li><a class="dropdown-item" href="#">Submenu item 3</a></li>
                            </ul>
                        </li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 3 &raquo; </a>
                            <ul class="submenu dropdown-menu">
                                <li><a class="dropdown-item" href="#">Another submenu 1</a></li>
                                <li><a class="dropdown-item" href="#">Another submenu 2</a></li>
                                <li><a class="dropdown-item" href="#">Another submenu 3</a></li>
                                <li><a class="dropdown-item" href="#">Another submenu 4</a></li>
                            </ul>
                        </li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 4 &raquo;</a>
                            <ul class="submenu dropdown-menu">
                                <li><a class="dropdown-item" href="#">Another submenu 1</a></li>
                                <li><a class="dropdown-item" href="#">Another submenu 2</a></li>
                                <li><a class="dropdown-item" href="#">Another submenu 3</a></li>
                                <li><a class="dropdown-item" href="#">Another submenu 4</a></li>
                            </ul>
                        </li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 5 </a></li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 6 </a></li>
                    </ul>
                </li>
            </ul>

            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="#"> Menu item </a></li>
                <li class="nav-item"><a class="nav-link" href="#"> Menu item </a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link  dropdown-toggle" href="#" data-bs-toggle="dropdown"> Dropdown right </a>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li><a class="dropdown-item" href="#"> Dropdown item 1</a></li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 2 </a></li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 3 &raquo; </a>
                            <ul class="submenu submenu-left dropdown-menu">
                                <li><a class="dropdown-item" href="">Submenu item 1</a></li>
                                <li><a class="dropdown-item" href="">Submenu item 2</a></li>
                                <li><a class="dropdown-item" href="">Submenu item 3</a></li>
                                <li><a class="dropdown-item" href="">Submenu item 4</a></li>
                            </ul>
                        </li>
                        <li><a class="dropdown-item" href="#"> Dropdown item 4 </a></li>
                    </ul>
                </li>
            </ul>

            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#">Login</a>
                </li>
            </ul>
        </div>
    </div>
</nav>


<div class="container">
    <div class="table-container" style="margin: 50px">
        <button id='add-new-row' type="button" data-bs-toggle="modal" data-bs-target="#add-row-modal"
                style="margin-bottom:20px " class="btn btn-primary">Add
        </button>

        <!-- New Row Modal -->
        <div class="modal fade" id="add-row-modal" tabindex="-1" aria-labelledby="add-row-modal-label"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="add-row-modal-label">Add new row</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="new-row-name" class="col-form-label">Name:</label>
                                <input type="text" class="form-control" id="new-row-name">
                            </div>
                            <div class="form-group">
                                <label for="new-row-type" class="col-form-label">Type:</label>
                                <select class="form-control" id="new-row-type">
                                    <option value="a">a</option>
                                    <option value="b">b</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-row-host" class="col-form-label">Host:</label>
                                <input type="text" class="form-control" id="new-row-host">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="save-new-row">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <table
                id="table"
                data-toggle="table"
                data-height="460"
                data-click-to-select="true"
                data-pagination="true"
                data-maintain-meta-data="true"
                data-url="data.json"
                data-sort-name="id"
                data-sort-order="desc"
        >
            <thead>
            <tr>
                <th data-field="id" data-sortable="true">ID</th>
                <th data-field="name" data-formatter="nameFormatter">Item Name</th>
                <th data-field="type" data-formatter="typeFormatter">Type</th>
                <th data-field="host" data-formatter="hostFormatter">Host</th>
                <th data-formatter="actionFormatter">Action</th>
            </tr>
            </thead>
        </table>
    </div>

</div>

<script>
    toastr.options = {
        "closeButton": false,
        "positionClass": "toast-top-right",
        "progressBar": false,
    }
</script>


<script>

    function saveRow($tr) {
        const id = $tr.find('td:eq(0)').text();
        const name = $tr.find('input[id="nameinput"]').val();
        const type = $tr.find('select.form-select').val();
        const host = $tr.find('input[id="hostinput"]').val();

        console.log($tr.data('unique-id'));
        console.log($tr.find('.editable:eq(0)').val());

        const data = {
            'id': id,
            'name': name,
            'type': type,
            'host': host
        };

        console.log(data)

        $.ajax({
            url: '/update-data',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function () {
                $('#table').bootstrapTable('refresh');
                toastr.success('update successfully!');

            },
            error: function (error) {
                console.log(error);
                alert('Failed to save the data. Please try again.');
            }
        });
    }

    // Define options for select input
    const typeOptions = [
        {value: "a", text: "a"},
        {value: "b", text: "b"}
    ];

    // Formatter for "name" column
    function nameFormatter(value, row, index) {
        return '<input id="nameinput" type="text" class="form-control" value="' + value + '">';
    }

    // Formatter for "name" column
    function hostFormatter(value, row, index) {
        return '<input id="hostinput" type="text" class="form-control" value="' + value + '">';
    }

    // Formatter for "type" column
    function typeFormatter(value, row, index) {
        let optionsHtml = '';
        typeOptions.forEach(option => {
            optionsHtml += '<option value="' + option.value + '"';
            if (option.value === value) {
                optionsHtml += ' selected';
            }
            optionsHtml += '>' + option.text + '</option>';
        });
        return '<select class="form-select">' + optionsHtml + '</select>';
    }

    // Formatter for "action" column
    function actionFormatter(value, row, index) {
        return '<button class="btn btn-sm btn-primary edit-row">Edit</button>' +
            '<button class="btn btn-sm btn-danger delete-row">Delete</button>'
    }

    const $table = $('#table');


    // Add event listeners for edit and delete buttons
    $table.on('click', '.edit-row', function () {
        const $tr = $(this).closest('tr');
        const $editBtn = $(this);
        const $saveBtn = $('<button class="btn btn-sm btn-success save-row">Save</button>');
        $editBtn.replaceWith($saveBtn);
        $tr.find('input, select').prop('disabled', false);
        $tr.find('input, select').addClass('editable');
        $tr.addClass('editing');
    });

    $table.on('click', '.save-row', function () {
        const $tr = $(this).closest('tr');
        const $saveBtn = $(this);
        const $editBtn = $('<button class="btn btn-sm btn-primary edit-row">Edit</button>');
        $saveBtn.replaceWith($editBtn);
        $tr.find('input, select').prop('disabled', true);
        $tr.find('input, select').removeClass('editable');
        $tr.removeClass('editing');
        // 调用 saveRow 保存编辑状态
        console.log($tr)
        saveRow($tr);
    });

    function deleteRow($tr) {
        const id = $tr.find('td:eq(0)').text();
        $.ajax({
            url: '/delete-data',
            type: 'POST',
            data: JSON.stringify({id: id}),
            contentType: 'application/json',
            success: function () {
                toastr.success('Delete successfully!');
                $tr.remove();
                $('#table').bootstrapTable('refresh');
            },
            error: function (error) {
                console.log(error);
                alert('Failed to delete the data. Please try again.');
            }
        });
    }


    $table.on('click', '.delete-row', function () {
        const $tr = $(this).closest('tr');

        bootbox.confirm({
            message: 'Please confirm if you want to delete?',
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-success'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-danger'
                }
            },
            callback: function (result) {
                if (result) {
                    deleteRow($tr)
                }
            }
        });

    });


</script>


<script>


    // 监听Add按钮点击事件，弹出填写新增行内容的窗口

    $('#add-new-row').click(function () {
        $('#add-row-modal').modal('show'); // 显示弹窗
    })


    $(document).ready(function () {
        const message_add = localStorage.getItem('message_add'); // 读取之前保存的消息
        if (message_add) {
            toastr["success"](message_add);
            localStorage.removeItem('message_add'); // 移除已经显示过的消息
        }
    });


    // your code here
    $('#save-new-row').click(function () {
        // Get the values of the new row from the form fields
        const id = $table.bootstrapTable('getData').length + 1;
        const name = $('#new-row-name').val();
        const type = $('#new-row-type').val();
        const host = $('#new-row-host').val();

        // Create a new row object with the values
        const newRow = {
            id: id,
            name: name,
            type: type,
            host: host
        };

        // Add the new row to the table
        $table.bootstrapTable('append', newRow);

        // Hide the modal dialog
        $('#add-row-modal').modal('hide');

        // addRow function
        $.ajax({
            url: '/add-row',
            type: 'POST',
            data: JSON.stringify({
                'id': newRow.id,
                'name': newRow.name,
                'type': newRow.type,
                'host': newRow.host
            }),
            contentType: 'application/json',
            success: function () {
                toastr.success('New row added successfully!');
                $('#add-row-modal').modal('hide');
                $('#table').bootstrapTable('refresh');
            },
            error: function () {
                toastr.error('Failed to add new row!');
            }
        });

    });


</script>


</body>
</html>
